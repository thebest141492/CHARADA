<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Códigos QR y Ventas</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
           background: linear-gradient(135deg, #110258, #0863ff); /* Fondo único */
           background-size: 100% 100%; /* Ajusta exactamente al tamaño del viewport      */
    background-repeat: no-repeat; /* Asegura que no se repita */
    background-position: center center;
    font-family: 'Roboto', sans-serif;
    overflow-x: hidden; /* Previene scroll horizontal no deseado */
            
        }
        .page-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100%;
            
        }

        
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f8f9fa;
        }
        .card {
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            background-color: rgba(255, 255, 255, 0.95);
            color: #333;
            border: none; /* Elimina bordes de la tarjeta */
            border-radius: 15px;
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
            padding: 30px;
            width: 100%;
            max-width: 400px;
            text-align: center;
        }
        .btn-primary {
            border-radius: 50px;
        }
        .menu-bar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100%;
            width: 250px;
            background: linear-gradient(135deg, rgba(16, 1, 68, 0.9), rgba(3, 96, 255, 0.9)); /* Fondo combinado con el escritorio */
            color: white;
            display: none; /* Ocultar el menú inicialmente */
            flex-direction: column;
            align-items: center;
            padding: 20px 10px;
            box-shadow: 2px 0 15px rgba(0, 0, 0, 0.5); /* Sombra más pronunciada */
            z-index: 1000;
            transition: transform 0.3s ease-in-out, background-color 0.5s, box-shadow 0.5s;
        }
        .menu-bar.visible {
            display: flex; /* Mostrar el menú después de iniciar sesión */
        }
        .menu-logo {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 20px;
            text-align: center;
            text-shadow: 2px 2px 5px rgba(0, 0, 0, 0.5); /* Sombra en el texto */
        }
        .menu-list {
            list-style: none;
            padding: 0;
            margin: 0;
            width: 100%;
        }
        .menu-item {
            padding: 10px 15px; /* Reducir el tamaño del padding */
            cursor: pointer;
            text-align: left;
            border-radius: 8px; /* Bordes más sutiles */
            transition: background-color 0.2s, transform 0.15s, color 0.2s, box-shadow 0.2s;
            font-size: 0.9rem; /* Reducir el tamaño de la fuente */
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px; /* Reducir el espacio entre ícono y texto */
            background-color: rgba(255, 255, 255, 0.1); /* Fondo translúcido */
        }
        .menu-item i {
            font-size: 1.2rem; /* Reducir el tamaño del ícono */
            transition: transform 0.2s, color 0.2s;
        }
        .menu-item:hover {
            background-color: rgba(255, 255, 255, 0.2); /* Fondo más claro al pasar el cursor */
            transform: scale(1.05); /* Efecto de zoom más sutil */
            color: #ffeb3b;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2); /* Sombra más ligera */
        }
        .menu-item:hover i {
            transform: rotate(10deg); /* Rotación más sutil del ícono */
            color: #ffeb3b;
        }
        .menu-item.active {
            background-color: rgba(255, 255, 255, 0.3); /* Fondo más destacado */
            color: #ffeb3b;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3); /* Sombra más ligera */
        }
        .menu-item.active i {
            transform: rotate(360deg); /* Rotación completa del ícono */
        }
        #menu-toggle-btn {
            display: none;
        }
        @media (max-width: 768px) {
            .menu-bar {
                transform: translateX(-100%);
            }
            .menu-bar.show {
                transform: translateX(0);
            }
            #menu-toggle-btn {
                display: block;
                position: fixed;
                top: 10px;
                left: 10px;
                background: none;
                border: none;
                font-size: 1.5rem;
                color: white;
                z-index: 1100;
                cursor: pointer;
            }
        }
        .main-content {
            margin-left: 0;
            padding: 20px;
            transition: margin-left 0.3s ease-in-out;
        }
        .main-content.menu-visible {
            margin-left: 250px; /* Ajustar el contenido cuando el menú está visible */
        }
        @media (max-width: 768px) {
            .main-content {
                margin-left: 0;
            }
        }
        .qr-container {
            margin-top: 20px;
            text-align: center;
        }
        .footer {
            text-align: center;
            font-size: 0.8rem; /* Reducir tamaño de fuente */
            color: white; /* Cambiar color a blanco */
            margin-top: 20px;
            position: fixed; /* Fijar al final de la página */
            bottom: 0;
            width: 100%;
        }
        #login-container, #register-container {
            background: none; /* Eliminar fondo específico */
            display: flex;
            justify-content: center; /* Centrar horizontalmente */
            align-items: center; /* Centrar verticalmente */
            height: 100vh; /* Altura completa de la ventana */
            width: 100%;
            color: white;
            position: absolute;
            top: 0;
            left: 0;
            margin: 0;
            padding-right: 10%; /* Espaciado desde la derecha */
            overflow: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            border: none;
        }
        #login-container.hidden, #register-container.hidden {
            opacity: 0;
            visibility: hidden;
        }
        .card h2 {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .card p {
            font-size: 1rem;
            margin-bottom: 20px;
        }
        .form-label {
            font-weight: bold;
            color: #555;
            text-align: left;
            display: block;
            margin-bottom: 5px;
        }
        #login-container img, #register-container img {
            width: 100px;
            margin: 0 auto 20px;
            display: block;
        }
        .btn-primary {
            background-color: #1165cb;
            border: none;
            border-radius: 50px;
            transition: background-color 0.3s, transform 0.2s;
        }
        .btn-primary:hover {
            background-color: #4e0fa3;
            transform: scale(1.05);
        }
        .text-primary {
            color: #6a11cb !important;
            font-weight: bold;
        }
        .text-primary:hover {
            text-decoration: underline;
        }
        #data-table thead th {
            background-color: #4e54c8; /* Color de fondo */
            color: white; /* Color del texto */
            text-align: center;
            padding: 10px;
            position: sticky; /* Fijar la cabecera */
            top: 0; /* Mantenerla en la parte superior */
            z-index: 1; /* Asegurar que esté por encima del contenido */
        }
        #register-container .card {
            max-width: 300px; /* Reducir el ancho máximo */
            padding: 20px; /* Reducir el padding */
        }
        #register-container img {
            width: 80px; /* Reducir el tamaño de la imagen */
            margin-bottom: 15px; /* Reducir el margen inferior */
        }
        #register-container h2 {
            font-size: 1.5rem; /* Reducir el tamaño del título */
        }
        #register-container p {
            font-size: 0.9rem; /* Reducir el tamaño del texto */
        }
        #login-container .card {
            max-width: 300px; /* Reducir el ancho máximo */
            padding: 20px; /* Reducir el padding */
        }
        #login-container img {
            width: 80px; /* Reducir el tamaño de la imagen */
            margin-bottom: 15px; /* Reducir el margen inferior */
        }
        #login-container h2 {
            font-size: 1.5rem; /* Reducir el tamaño del título */
        }
        #login-container p {
            font-size: 0.9rem; /* Reducir el tamaño del texto */
        }
        #qr-generator, #sales-container, #qr-generator-moda, #sales-container-moda {
            display: none; /* Ocultar las secciones al inicio */
        }
        #sales-container, #sales-container-moda {
            overflow-x: auto; /* Habilitar desplazamiento horizontal */
            overflow-y: auto; /* Habilitar desplazamiento vertical */
            margin-top: 0; /* Eliminar margen superior */
            height: 100vh; /* Altura completa de la ventana */
            width: calc(100vw - 250px); /* Ancho ajustado desde el borde derecho del menú */
            position: fixed; /* Fijar el contenedor en la página */
            top: 0; /* Alinear al inicio */
            left: 250px; /* Ajustar desde el borde derecho del menú */
            z-index: 10; /* Asegurar que esté por encima de otros elementos */
        }
        #data-table-container, #data-table-container-moda {
            position: relative;
            height: auto; /* Ajustar automáticamente la altura */
            max-height: 100%; /* Permitir que ocupe todo el espacio disponible */
            overflow-y: auto; /* Habilitar desplazamiento vertical */
            overflow-x: auto; /* Habilitar desplazamiento horizontal */
        }
        @media (max-width: 1200px) {
            #data-table-container, #data-table-container-moda {
                max-height: 500px; /* Altura máxima en pantallas medianas */
            }
        }
        @media (max-width: 768px) {
            #data-table-container, #data-table-container-moda {
                max-height: 300px; /* Altura máxima en pantallas pequeñas */
            }
        }
        @media (max-width: 576px) {
            #data-table-container, #data-table-container-moda {
                max-height: 200px; /* Altura máxima en pantallas muy pequeñas */
            }
        }
        #data-table, #data-table-moda {
            min-width: 100%; /* Ajustar el ancho mínimo al contenedor */
            border-collapse: collapse; /* Eliminar espacios entre bordes */
            width: 100%; /* Ajustar la tabla al ancho del contenedor */
        }
        #data-table thead th, #data-table-moda thead th {
            position: sticky; /* Fijar la cabecera */
            bottom: 0; /* Mantenerla en la parte inferior */
            z-index: 1; /* Asegurar que esté por encima del contenido */
            background-color: #4e54c8; /* Color de fondo */
            color: white; /* Color del texto */
            text-align: center;
            padding: 10px;
        }
        #data-table tbody td, #data-table-moda tbody td {
            text-align: center; /* Centrar el contenido de las celdas */
        }
        #sales-container .card, #sales-container-moda .card {
            width: 100%; /* Ocupa todo el ancho de la página */
            max-width: none; /* Elimina el límite de ancho máximo */
            padding: 40px; /* Mantener el padding interno */
            height: 720px; /* Aumentar la altura del formulario */
        }
        #filter-input, #filter-input-moda {
            font-size: 1.2rem; /* Aumentar el tamaño de la fuente del campo de entrada */
            padding: 10px; /* Aumentar el padding del campo de entrada */
        }
        #filter-label, #filter-label-moda {
            font-size: 1.1rem; /* Aumentar el tamaño de la fuente de la etiqueta */
        }
        .card {
            width: 90%; /* Ajustar el ancho al 90% del contenedor */
            max-width: 400px; /* Ancho máximo */
            padding: 20px; /* Reducir padding */
        }
        @media (max-width: 768px) {
            .card {
                max-width: 200px; /* Reducir ancho máximo en pantallas pequeñas */
            }
        }
        #menu-bar {
            width: 250px; /* Ancho fijo */
        }
        @media (max-width: 768px) {
            #menu-bar {
                width: 200px; /* Reducir ancho en pantallas pequeñas */
            }
        }
        .main-content {
            margin-left: 0;
            padding: 10px; /* Reducir padding en pantallas pequeñas */
        }
        @media (max-width: 768px) {
            .main-content {
                margin-left: 0;
            }
        }
        .footer {
            font-size: 0.8rem; /* Reducir tamaño de fuente en el pie de página */
        }
        #login-container, #register-container {
            display: flex;
            justify-content: center; /* Centrar horizontalmente */
            align-items: center; /* Centrar verticalmente */
            height: 100vh; /* Altura completa de la ventana */
            width: 100%;
            position: fixed; /* Fijar posición en la pantalla */
            top: 0;
            left: 0;
            margin: 0;
            overflow: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        #data-table, .table {
            font-size: 0.8rem; /* Reducir el tamaño de la fuente de las tablas */
        }
    </style>
</head>
<body>
    <div class="page-container">



        <!-- Menú interactivo -->
        <nav id="menu-bar" class="menu-bar visible">
        <div class="menu-logo" style="display: flex; align-items: center;">
        <span style="font-weight: bold; font-size: 29px;">APP CARDIG</span>
        <img src="LOGO.png" alt="Logo" style="height: 60px; margin-left: 10px;" />
    </div>


            <ul id="menu-list" class="menu-list">
                <li class="menu-item active" onclick="showQRGenerator()">
                    <i class="fas fa-qrcode"></i>
                    <span>Resurtidos</span>
                </li>
                <li class="menu-item" onclick="showSales()">
                    <i class="fas fa-chart-line"></i>
                    <span>Etiquetas "Resurtidos"</span>
                </li>
                <!-- Botones para Moda -->
                <li class="menu-item" onclick="showQRGeneratorModa()">
                    <i class="fas fa-qrcode"></i>
                    <span>Moda</span>
                </li>
                <li class="menu-item" onclick="showSalesModa()">
                    <i class="fas fa-chart-line"></i>
                    <span>Etiquetas Moda</span>
                </li>
            </ul>
        </nav>

        <!-- Contenido principal -->
        <div id="main-content" class="main-content menu-visible" style="display: block;">
            <header class="header d-flex justify-content-between align-items-center mb-3">
                <button id="menu-toggle-btn" class="btn btn-outline-secondary" onclick="toggleMenu()">☰</button>
            </header>

            <main class="main-content">
                <!-- Generador de QR Resurtidos -->
                <section id="qr-generator" class="container" style="display: block;">
                    
                    <div class="card p-5 mx-auto shadow-lg border-0" style="width: 100%; max-width: 1000px; border-radius: 20px; background: #ffffff;">
                        <h2 class="text-center mb-4" style="font-weight: 600; color: #2c3e50;">Subir Archivo Excel</h2>
                        <div class="d-flex flex-column align-items-center justify-content-center" 
                            style="border: 2px dashed #3498db; padding: 50px; border-radius: 15px; background-color: #f0f8ff; transition: background-color 0.3s ease; cursor: pointer;" 
                            id="drop-area" 
                            aria-labelledby="drop-area-label" 
                            role="region">
                             <!-- Reemplaza el ícono SVG por una imagen PNG llamativa -->
           <!-- Reemplazo del ícono SVG por un GIF animado -->
<img src="https://lidianet.com/ldnt/wp-content/uploads/2020/03/FileUpLoad_lidianet.gif" 
     alt="Animación subir archivo" 
     style="max-width: 230px; margin-bottom: 10px; border-radius: 10px;">


                            <label for="excel-file" class="form-label fs-5 text-center" id="drop-area-label" style="color: #2c3e50;">
                                Arrastra y suelta un archivo Excel aquí o haz clic para seleccionarlo
                            </label>

                            
                            <input type="file" id="excel-file" class="form-control w-150 mt-3" accept=".xlsx, .xls" onchange="handleExcelUpload()" 
                                style="max-width: 400px; cursor: pointer;">
                            <small class="form-text text-muted mt-2">Formatos permitidos: .xlsx, .xls</small>
                        </div>
                    </div>
                </section>

                <!-- Generador de QR Moda -->
                <section id="qr-generator-moda" class="container" style="display: none;">
                    <div class="card p-5 mx-auto shadow-lg border-0" style="width: 100%; max-width: 1000px; border-radius: 20px; background: #ffffff;">
                        <h2 class="text-center mb-4" style="font-weight: 600; color: #2c3e50;">Subir Archivo Excel Moda</h2>
                        <div class="d-flex flex-column align-items-center justify-content-center"
                            style="border: 2px dashed #e91e63; padding: 50px; border-radius: 15px; background-color: #fce4ec; transition: background-color 0.3s ease; cursor: pointer;"
                            id="drop-area-moda"
                            aria-labelledby="drop-area-label-moda"
                            role="region">
                            <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" fill="#e91e63" class="mb-3" viewBox="0 0 16 16">
                                <path d="M.5 9.9a.5.5 0 0 1 .5-.4h5.6l.9-.9a.5.5 0 0 1 .7 0l.9.9h5.6a.5.5 0 0 1 0 1H9.1l-.9.9a.5.5 0 0 1-.7 0l-.9-.9H1a.5.5 0 0 1-.5-.5z"/>
                                <path d="M1 13a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v.5a.5.5 0 0 1-.5.5h-13a.5.5 0 0 1-.5-.5V13z"/>
                            </svg>
                            <label for="excel-file-moda" class="form-label fs-5 text-center" id="drop-area-label-moda" style="color: #2c3e50;">
                                Arrastra y suelta un archivo Excel aquí o haz clic para seleccionarlo
                            </label>
                            <input type="file" id="excel-file-moda" class="form-control w-50 mt-3" accept=".xlsx, .xls" onchange="handleExcelUploadModa()"
                                style="max-width: 400px; cursor: pointer;">
                            <small class="form-text text-muted mt-2">Formatos permitidos: .xlsx, .xls</small>
                        </div>
                    </div>
                </section>

                <!-- Ventas Resurtidos -->
                <section id="sales-container" class="container-fluid" style="display: none; height: 100vh;">
                    <div class="card p-4 h-100">
                        <h2 class="text-center">Impresión de códigos</h2>
                        <div class="mb-3 d-flex align-items-center flex-wrap gap-2">
                            <button class="btn btn-secondary" onclick="showUniqueModels()">Modelos</button>
                            <select id="model-select" class="form-select" style="display: none; width: auto;" onchange="filterByModel()">
                                <option value="">Selecciona un modelo</option>
                            </select>
                            <button class="btn btn-danger" style="display: none;" id="clear-model-filter" onclick="clearModelFilter()">Quitar filtro</button>
                            <button class="btn btn-secondary" onclick="showUniqueStores()">Tiendas</button>
                            <select id="store-select" class="form-select" style="display: none; width: auto;" onchange="filterByStore()">
                                <option value="">Selecciona una tienda</option>
                            </select>
                            <button class="btn btn-danger" style="display: none;" id="clear-store-filter" onclick="clearStoreFilter()">Quitar filtro</button>
                            <button class="btn btn-secondary" onclick="showUniqueCedis()">Cedis</button>
                            <select id="cedis-select" class="form-select" style="display: none; width: auto;" onchange="filterByCedis()">
                                <option value="">Selecciona un cedis</option>
                            </select>
                            <button class="btn btn-danger" style="display: none;" id="clear-cedis-filter" onclick="clearCedisFilter()">Quitar filtro</button>
                            <button class="btn btn-primary ms-auto" onclick="printContainer()">Imprimir</button>
                        </div>
                        <div id="print-container" style="display: none; width: 900px; height: 900px; border: 1px solid black; padding: 10px; font-size: 0.9rem;">
                        </div>
                        <div id="data-table-container">
                        </div>
                    </div>
                </section>

                <!-- Ventas Moda -->
                <section id="sales-container-moda" class="container-fluid" style="display: none; height: 100vh;">
                    <div class="card p-4 h-100">
                        <h2 class="text-center">Impresión de códigos Moda</h2>
                        <!-- Filtros Moda -->
                        <div class="mb-3 d-flex align-items-center flex-wrap gap-2">
                            <button class="btn btn-secondary" onclick="showUniqueModelsModa()">Modelos</button>
                            <select id="model-select-moda" class="form-select" style="display: none; width: auto;" onchange="filterByModelModa()">
                                <option value="">Selecciona un modelo</option>
                            </select>
                            <button class="btn btn-danger" style="display: none;" id="clear-model-filter-moda" onclick="clearModelFilterModa()">Quitar filtro</button>
                            <button class="btn btn-secondary" onclick="showUniqueStoresModa()">Tiendas</button>
                            <select id="store-select-moda" class="form-select" style="display: none; width: auto;" onchange="filterByStoreModa()">
                                <option value="">Selecciona una tienda</option>
                            </select>
                            <button class="btn btn-danger" style="display: none;" id="clear-store-filter-moda" onclick="clearStoreFilterModa()">Quitar filtro</button>
                            <button class="btn btn-secondary" onclick="showUniqueCedisModa()">Cedis</button>
                            <select id="cedis-select-moda" class="form-select" style="display: none; width: auto;" onchange="filterByCedisModa()">
                                <option value="">Selecciona un cedis</option>
                            </select>
                            <button class="btn btn-danger" style="display: none;" id="clear-cedis-filter-moda" onclick="clearCedisFilterModa()">Quitar filtro</button>
                            <button class="btn btn-primary ms-auto" onclick="printContainerModa()">Imprimir</button>
                        </div>
                        <div id="print-container-moda" style="display: none; width: 900px; height: 900px; border: 1px solid black; padding: 10px; font-size: 0.9rem;">
                        </div>
                        <div id="data-table-container-moda">
                        </div>
                    </div>
                </section>
            </main>
        </div>
    </div>

    <!-- Modal para impresión -->
    <div class="modal fade" id="printModal" tabindex="-1" aria-labelledby="printModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header d-flex justify-content-between align-items-center">
                    <h5 class="modal-title mb-0" id="printModalLabel">Previsualización de impresión</h5>
                    <div>
                        <button type="button" class="btn btn-primary me-2" onclick="printModalLabels()">
                            <i class="bi bi-printer me-1"></i> Imprimir
                        </button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="bi bi-x-circle me-1"></i> Cerrar
                        </button>
                    </div>
                </div>
                <div class="modal-body">
                    <div id="modal-label-container" 
                        style="width: 90mm; margin: 0 auto; display: flex; flex-wrap: wrap; justify-content: center; gap: 1rem; border: 1px solid #ccc; padding: 10px;">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer">
        <p>&copy; 2025 Impresion de Códigos QR Ferreira. Todos los derechos reservados.</p>
    </footer>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <script src="script.js"></script>
    <script>
        function deleteRow(button) {
            const row = button.closest('tr');
            const table = row.closest('table');
            const titleElement = table.previousElementSibling;
            const piezas = parseInt(row.children[9]?.textContent || 0);
            row.remove();
            // Recalcular total de piezas
            updateTotalPiezas(table, titleElement);
            showNotification('Se eliminó correctamente.', 'info');
        }

        function deleteRowModa(button) {
            const row = button.closest('tr');
            const table = row.closest('table');
            const titleElement = table.previousElementSibling;
            const piezas = parseInt(row.children[9]?.textContent || 0);
            row.remove();
            // Recalcular total de piezas
            updateTotalPiezas(table, titleElement);
            showNotification('Se eliminó correctamente.', 'info');
        }

        function enableEdit(button) {
            const row = button.closest('tr');
            const editableCell = row.children[9];
            const table = row.closest('table');
            const titleElement = table.previousElementSibling;
            if (editableCell) {
                const originalValue = parseInt(editableCell.textContent) || 0;
                editableCell.setAttribute('contenteditable', 'true');
                editableCell.focus();
                editableCell.style.backgroundColor = '#fff3cd';
                editableCell.addEventListener('blur', function onBlur() {
                    editableCell.removeEventListener('blur', onBlur);
                    editableCell.setAttribute('contenteditable', 'false');
                    editableCell.style.backgroundColor = '';
                    // Recalcular total de piezas
                    updateTotalPiezas(table, titleElement);
                });
            }
        }

        function enableEditModa(button) {
            const row = button.closest('tr');
            const editableCell = row.children[9];
            const table = row.closest('table');
            const titleElement = table.previousElementSibling;
            if (editableCell) {
                const originalValue = parseInt(editableCell.textContent) || 0;
                editableCell.setAttribute('contenteditable', 'true');
                editableCell.focus();
                editableCell.style.backgroundColor = '#fff3cd';
                editableCell.addEventListener('blur', function onBlur() {
                    editableCell.removeEventListener('blur', onBlur);
                    editableCell.setAttribute('contenteditable', 'false');
                    editableCell.style.backgroundColor = '';
                    // Recalcular total de piezas
                    updateTotalPiezas(table, titleElement);
                });
            }
        }

        // Función para recalcular el total de piezas de la tabla y actualizar el título
        function updateTotalPiezas(table, titleElement) {
            let total = 0;
            const rows = table.querySelectorAll('tbody tr');
            rows.forEach(row => {
                // Solo contar filas visibles (por si hay filtros)
                if (row.style.display === 'none') return;
                const val = parseInt(row.children[9]?.textContent || 0);
                if (!isNaN(val)) total += val;
            });
            titleElement.innerHTML = titleElement.innerHTML.replace(
                /<strong>Total de piezas:<\/strong> \d+/,
                `<strong>Total de piezas:</strong> ${total}`
            );
        }

        function handleExcelUpload() {
            const fileInput = document.getElementById('excel-file');
            const file = fileInput.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                const container = document.getElementById('data-table-container');
                container.innerHTML = '';
                const headers = jsonData[0];
                const groupedData = {};
                jsonData.slice(1).forEach(row => {
                    const key = `${row[2]} - ${row[3]}`;
                    if (!groupedData[key]) {
                        groupedData[key] = [];
                    }
                    groupedData[key].push(row);
                });
                Object.keys(groupedData).forEach((key, groupIdx) => {
                    const groupContainer = document.createElement('div');
                    groupContainer.classList.add('group-container', 'mb-4');
                    groupContainer.setAttribute('data-group-key', key);
                    groupContainer.setAttribute('data-caja', '1');
                    groupContainer.setAttribute('data-total-cajas', '1');
                    const [cedis, tienda] = key.split(' - ');
                    const pedido = groupedData[key][0][1];
                    const totalPiezas = groupedData[key].reduce((sum, row) => sum + (parseInt(row[9]) || 0), 0);
                    const title = document.createElement('div');
                    title.classList.add('d-flex', 'justify-content-around', 'align-items-center', 'mb-3', 'p-2', 'bg-light', 'rounded', 'shadow-sm');
                    title.style.gap = '20px';
                    title.innerHTML = `
                        <div><strong>Cedis:</strong> ${cedis}</div>
                        <div><strong>Tienda:</strong> ${tienda}</div>
                        <div><strong>Pedido:</strong> ${pedido}</div>
                        <div>
                            <strong>Total de piezas:</strong> ${totalPiezas}
                            <button class="btn btn-success btn-sm ms-2" onclick="duplicateGroup(this)">Duplicar cajas</button>
                            <button class="btn btn-danger btn-sm ms-1" style="display:none;" onclick="removeGroupDuplicate(this)">Eliminar duplicado</button>
                        </div>
                    `;
                    const cajaDiv = document.createElement('div');
                    cajaDiv.className = 'caja-info';
                    cajaDiv.style.fontWeight = 'bold';
                    cajaDiv.style.fontSize = '1rem';
                    cajaDiv.style.marginTop = '5px';
                    cajaDiv.innerHTML = `Caja: 1 de 1`;
                    title.insertBefore(cajaDiv, title.children[1]);
                    groupContainer.appendChild(title);
                    const table = document.createElement('table');
                    table.classList.add('table', 'table-striped');
                    groupContainer.appendChild(table);
                    const thead = document.createElement('thead');
                    const headerRow = document.createElement('tr');
                    headers.forEach((header, index) => {
                        const th = document.createElement('th');
                        th.textContent = header;
                        th.style.backgroundColor = '#4e54c8';
                        th.style.color = 'white';
                        th.style.textAlign = 'center';
                        th.style.padding = '10px';
                        if (index === 0 || index === 1) th.style.display = 'none';
                        headerRow.appendChild(th);
                    });
                    thead.appendChild(headerRow);
                    table.appendChild(thead);
                    const tbody = document.createElement('tbody');
                    groupedData[key].forEach(row => {
                        const tr = document.createElement('tr');
                        row.forEach((cell, index) => {
                            const td = document.createElement('td');
                            td.textContent = cell;
                            if (index === 0 || index === 1) td.style.display = 'none';
                            if (index === 9) td.setAttribute('contenteditable', 'false');
                            tr.appendChild(td);
                        });
                        const actionTd = document.createElement('td');
                        actionTd.innerHTML = `
                            <button class="btn btn-warning btn-sm" onclick="enableEdit(this)">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="deleteRow(this)">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                            <button class="btn btn-info btn-sm" onclick="duplicateRow(this)">
                                <i class="fas fa-copy"></i>
                            </button>
                        `;
                        tr.appendChild(actionTd);
                        tbody.appendChild(tr);
                    });
                    table.appendChild(tbody);
                    groupContainer.appendChild(table);
                    container.appendChild(groupContainer);
                });
            };
            reader.readAsArrayBuffer(file);
        }

        function handleExcelUploadModa() {
            const fileInputModa = document.getElementById('excel-file-moda');
            const file = fileInputModa.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                const container = document.getElementById('data-table-container-moda');
                container.innerHTML = '';
                const headers = jsonData[0];
                const groupedData = {};
                jsonData.slice(1).forEach(row => {
                    const key = `${row[2]} - ${row[3]}`;
                    if (!groupedData[key]) {
                        groupedData[key] = [];
                    }
                    groupedData[key].push(row);
                });
                Object.keys(groupedData).forEach(key => {
                    const groupContainer = document.createElement('div');
                    groupContainer.classList.add('group-container', 'mb-4');
                    const [cedis, tienda] = key.split(' - ');
                    const pedido = groupedData[key][0][1];
                    const totalPiezas = groupedData[key].reduce((sum, row) => sum + (parseInt(row[9]) || 0), 0);
                    const title = document.createElement('div');
                    title.classList.add('d-flex', 'justify-content-around', 'align-items-center', 'mb-3', 'p-2', 'bg-light', 'rounded', 'shadow-sm');
                    title.style.gap = '20px';
                    title.innerHTML = `
                        <div><strong>Cedis:</strong> ${cedis}</div>
                        <div><strong>Tienda:</strong> ${tienda}</div>
                        <div><strong>Pedido:</strong> ${pedido}</div>
                        <div><strong>Total de piezas:</strong> ${totalPiezas}</div>
                    `;
                    groupContainer.appendChild(title);
                    const table = document.createElement('table');
                    table.classList.add('table', 'table-striped');
                    groupContainer.appendChild(table);
                    const thead = document.createElement('thead');
                    const headerRow = document.createElement('tr');
                    headers.forEach((header, index) => {
                        const th = document.createElement('th');
                        th.textContent = header;
                        th.style.backgroundColor = '#e91e63';
                        th.style.color = 'white';
                        th.style.textAlign = 'center';
                        th.style.padding = '10px';
                        if (index === 0 || index === 1) th.style.display = 'none';
                        headerRow.appendChild(th);
                    });
                    thead.appendChild(headerRow);
                    table.appendChild(thead);
                    const tbody = document.createElement('tbody');
                    groupedData[key].forEach(row => {
                        const tr = document.createElement('tr');
                        row.forEach((cell, index) => {
                            const td = document.createElement('td');
                            td.textContent = cell;
                            if (index === 0 || index === 1) td.style.display = 'none';
                            if (index === 9) td.setAttribute('contenteditable', 'false');
                            tr.appendChild(td);
                        });
                        const actionTd = document.createElement('td');
                        actionTd.innerHTML = `
                            <button class="btn btn-warning btn-sm" onclick="enableEditModa(this)">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="deleteRowModa(this)">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                            <button class="btn btn-info btn-sm" onclick="duplicateRowModa(this)">
                                <i class="fas fa-copy"></i>
                            </button>
                        `;
                        tr.appendChild(actionTd);
                        tbody.appendChild(tr);
                    });
                    table.appendChild(tbody);
                    groupContainer.appendChild(table);
                    container.appendChild(groupContainer);
                });
            };
            reader.readAsArrayBuffer(file);
        }

        function toggleMenu() {
            const menuBar = document.getElementById('menu-bar');
            menuBar.classList.toggle('show');
        }
        window.addEventListener('scroll', () => {
            const menuBar = document.getElementById('menu-bar');
            if (window.scrollY > 50) {
                menuBar.classList.add('hidden');
            } else {
                menuBar.classList.remove('hidden');
            }
        });

        function setActiveMenuItem(selectedItem) {
            const menuItems = document.querySelectorAll('.menu-item');
            menuItems.forEach(item => {
                item.classList.remove('active');
            });
            selectedItem.classList.add('active');
        }

        function showQRGenerator() {
            setActiveMenuItem(document.querySelector('.menu-item:nth-child(1)'));
            document.getElementById('qr-generator').style.display = 'block';
            document.getElementById('sales-container').style.display = 'none';
            document.getElementById('qr-generator-moda').style.display = 'none';
            document.getElementById('sales-container-moda').style.display = 'none';
        }

        function showSales() {
            setActiveMenuItem(document.querySelector('.menu-item:nth-child(2)'));
            document.getElementById('sales-container').style.display = 'block';
            document.getElementById('qr-generator').style.display = 'none';
            document.getElementById('qr-generator-moda').style.display = 'none';
            document.getElementById('sales-container-moda').style.display = 'none';
        }

        function showQRGeneratorModa() {
            setActiveMenuItem(document.querySelector('.menu-item:nth-child(3)'));
            document.getElementById('qr-generator').style.display = 'none';
            document.getElementById('sales-container').style.display = 'none';
            document.getElementById('qr-generator-moda').style.display = 'block';
            document.getElementById('sales-container-moda').style.display = 'none';
        }

        function showSalesModa() {
            setActiveMenuItem(document.querySelector('.menu-item:nth-child(4)'));
            document.getElementById('sales-container').style.display = 'none';
            document.getElementById('qr-generator').style.display = 'none';
            document.getElementById('qr-generator-moda').style.display = 'none';
            document.getElementById('sales-container-moda').style.display = 'block';
        }

        const dropArea = document.getElementById('drop-area');
        const fileInput = document.getElementById('excel-file');
        dropArea.addEventListener('dragover', (event) => {
            event.preventDefault();
            dropArea.style.backgroundColor = '#a5d6a7'; // verde claro
            dropArea.style.borderColor = '#388e3c'; // verde oscuro
        });
        dropArea.addEventListener('dragleave', () => {
            dropArea.style.backgroundColor = '#f0f8ff';
            dropArea.style.borderColor = '#3498db';
        });
        dropArea.addEventListener('drop', (event) => {
            event.preventDefault();
            const file = event.dataTransfer.files[0];
            if (file && (file.name.endsWith('.xlsx') || file.name.endsWith('.xls'))) {
                fileInput.files = event.dataTransfer.files;
                dropArea.style.backgroundColor = '#a5d6a7'; // verde claro
                dropArea.style.borderColor = '#388e3c'; // verde oscuro
                handleExcelUpload();
            } else {
                alert('Por favor, sube un archivo Excel válido (.xlsx, .xls)');
            }
        });
        fileInput.addEventListener('change', () => {
            if (fileInput.files.length > 0) {
                dropArea.style.backgroundColor = '#a5d6a7'; // verde claro
                dropArea.style.borderColor = '#388e3c'; // verde oscuro
            }
        });

        const dropAreaModa = document.getElementById('drop-area-moda');
        const fileInputModa = document.getElementById('excel-file-moda');
        dropAreaModa.addEventListener('dragover', (event) => {
            event.preventDefault();
            dropAreaModa.style.backgroundColor = '#a5d6a7'; // verde claro
            dropAreaModa.style.borderColor = '#388e3c'; // verde oscuro
        });
        dropAreaModa.addEventListener('dragleave', () => {
            dropAreaModa.style.backgroundColor = '#fce4ec';
            dropAreaModa.style.borderColor = '#e91e63';
        });
        dropAreaModa.addEventListener('drop', (event) => {
            event.preventDefault();
            const file = event.dataTransfer.files[0];
            if (file && (file.name.endsWith('.xlsx') || file.name.endsWith('.xls'))) {
                fileInputModa.files = event.dataTransfer.files;
                dropAreaModa.style.backgroundColor = '#a5d6a7'; // verde claro
                dropAreaModa.style.borderColor = '#388e3c'; // verde oscuro
                handleExcelUploadModa();
            } else {
                alert('Por favor, sube un archivo Excel válido (.xlsx, .xls)');
            }
        });
        fileInputModa.addEventListener('change', () => {
            if (fileInputModa.files.length > 0) {
                dropAreaModa.style.backgroundColor = '#a5d6a7'; // verde claro
                dropAreaModa.style.borderColor = '#388e3c'; // verde oscuro
            }
        });

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification-popup alert alert-${type}`;
            const icon = document.createElement('i');
            icon.style.marginRight = '15px';
            icon.style.fontSize = '1.5rem';
            if (type === 'success') {
                icon.className = 'fas fa-check-circle';
                icon.style.color = '#ffffff';
                notification.style.background = 'rgba(76, 175, 80, 0.8)';
            } else if (type === 'error') {
                icon.className = 'fas fa-times-circle';
                icon.style.color = '#ffffff';
                notification.style.background = 'rgba(244, 67, 54, 0.8)';
            } else if (type === 'info') {
                icon.className = 'fas fa-info-circle';
                icon.style.color = '#ffffff';
                notification.style.background = 'rgba(33, 150, 243, 0.8)';
            } else if (type === 'warning') {
                icon.className = 'fas fa-exclamation-circle';
                icon.style.color = '#000000';
                notification.style.background = 'rgba(255, 193, 7, 0.8)';
                notification.style.color = '#212529';
            }
            notification.style.position = 'fixed';
            notification.style.bottom = '-100px';
            notification.style.right = '20px';
            notification.style.zIndex = '2000';
            notification.style.minWidth = '350px';
            notification.style.padding = '20px';
            notification.style.borderRadius = '15px';
            notification.style.fontWeight = 'bold';
            notification.style.color = '#fff';
            notification.style.boxShadow = '0 15px 30px rgba(0, 0, 0, 0.4)';
            notification.style.transition = 'bottom 0.6s ease, opacity 0.4s ease';
            notification.style.backdropFilter = 'blur(10px)';
            notification.appendChild(icon);
            notification.appendChild(document.createTextNode(message));
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.style.bottom = '30px';
            }, 100);
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.bottom = '-100px';
                setTimeout(() => notification.remove(), 600);
            }, 4000);
        }

        // --- Filtros y funciones de impresión para MODA (idénticos a los de Resurtidos pero para los IDs *_moda) ---

        function showUniqueModelsModa() {
            const tables = document.querySelectorAll('#data-table-container-moda table');
            const uniqueModels = new Set();
            tables.forEach(table => {
                const rows = table.querySelectorAll('tbody tr');
                rows.forEach(row => {
                    const modelCell = row.children[5];
                    if (modelCell) uniqueModels.add(modelCell.textContent.trim());
                });
            });
            const modelSelect = document.getElementById('model-select-moda');
            modelSelect.innerHTML = '<option value="">Selecciona un modelo</option>';
            uniqueModels.forEach(model => {
                const option = document.createElement('option');
                option.value = model;
                option.textContent = model;
                modelSelect.appendChild(option);
            });
            modelSelect.style.display = 'block';
            document.getElementById('clear-model-filter-moda').style.display = 'block';
        }

        function filterByModelModa() {
            const selectedModel = document.getElementById('model-select-moda').value;
            const tables = document.querySelectorAll('#data-table-container-moda .group-container');
            tables.forEach(group => {
                const table = group.querySelector('table');
                let hasVisibleRows = false;
                const rows = table.querySelectorAll('tbody tr');
                rows.forEach(row => {
                    const modelCell = row.children[5];
                    if (modelCell) {
                        const isVisible = selectedModel ? modelCell.textContent.trim() === selectedModel : true;
                        row.style.display = isVisible ? '' : 'none';
                        if (isVisible) hasVisibleRows = true;
                    }
                });
                group.style.display = hasVisibleRows ? '' : 'none';
            });
        }

        function clearModelFilterModa() {
            document.getElementById('model-select-moda').value = '';
            filterByModelModa();
            document.getElementById('clear-model-filter-moda').style.display = 'none';
        }

        function showUniqueStoresModa() {
            const tables = document.querySelectorAll('#data-table-container-moda table');
            const uniqueStores = new Set();
            tables.forEach(table => {
                const rows = table.querySelectorAll('tbody tr');
                rows.forEach(row => {
                    const storeCell = row.children[3];
                    if (storeCell) uniqueStores.add(storeCell.textContent.trim());
                });
            });
            const storeSelect = document.getElementById('store-select-moda');
            storeSelect.innerHTML = '<option value="">Selecciona una tienda</option>';
            uniqueStores.forEach(store => {
                const option = document.createElement('option');
                option.value = store;
                option.textContent = store;
                storeSelect.appendChild(option);
            });
            storeSelect.style.display = 'block';
            document.getElementById('clear-store-filter-moda').style.display = 'block';
        }

        function filterByStoreModa() {
            const selectedStore = document.getElementById('store-select-moda').value;
            const tables = document.querySelectorAll('#data-table-container-moda .group-container');
            tables.forEach(group => {
                const table = group.querySelector('table');
                let hasVisibleRows = false;
                const rows = table.querySelectorAll('tbody tr');
                rows.forEach(row => {
                    const storeCell = row.children[3];
                    if (storeCell) {
                        const isVisible = selectedStore ? storeCell.textContent.trim() === selectedStore : true;
                        row.style.display = isVisible ? '' : 'none';
                        if (isVisible) hasVisibleRows = true;
                    }
                });
                group.style.display = hasVisibleRows ? '' : 'none';
            });
        }

        function clearStoreFilterModa() {
            document.getElementById('store-select-moda').value = '';
            filterByStoreModa();
            document.getElementById('clear-store-filter-moda').style.display = 'none';
        }

        function showUniqueCedisModa() {
            const tables = document.querySelectorAll('#data-table-container-moda table');
            const uniqueCedis = new Set();
            tables.forEach(table => {
                const rows = table.querySelectorAll('tbody tr');
                rows.forEach(row => {
                    const cedisCell = row.children[7];
                    if (cedisCell) uniqueCedis.add(cedisCell.textContent.trim());
                });
            });
            const cedisSelect = document.getElementById('cedis-select-moda');
            cedisSelect.innerHTML = '<option value="">Selecciona un cedis</option>';
            uniqueCedis.forEach(cedis => {
                const option = document.createElement('option');
                option.value = cedis;
                option.textContent = cedis;
                cedisSelect.appendChild(option);
            });
            cedisSelect.style.display = 'block';
            document.getElementById('clear-cedis-filter-moda').style.display = 'block';
        }

        function filterByCedisModa() {
            const selectedCedis = document.getElementById('cedis-select-moda').value;
            const tables = document.querySelectorAll('#data-table-container-moda .group-container');
            tables.forEach(group => {
                const table = group.querySelector('table');
                let hasVisibleRows = false;
                const rows = table.querySelectorAll('tbody tr');
                rows.forEach(row => {
                    const cedisCell = row.children[2];
                    if (cedisCell) {
                        const isVisible = selectedCedis ? cedisCell.textContent.trim() === selectedCedis : true;
                        row.style.display = isVisible ? '' : 'none';
                        if (isVisible) hasVisibleRows = true;
                    }
                });
                group.style.display = hasVisibleRows ? '' : 'none';
            });
        }

        function clearCedisFilterModa() {
            document.getElementById('cedis-select-moda').value = '';
            filterByCedisModa();
            document.getElementById('clear-cedis-filter-moda').style.display = 'none';
        }

        function showUniqueStores() {
            // Si hay un cedis seleccionado, solo mostrar tiendas de ese cedis
            const selectedCedis = document.getElementById('cedis-select').value;
            const tables = document.querySelectorAll('#data-table-container .group-container');
            const uniqueStores = new Set();
            tables.forEach(group => {
                const table = group.querySelector('table');
                const rows = table.querySelectorAll('tbody tr');
                rows.forEach(row => {
                    const cedisCell = row.children[2];
                    const storeCell = row.children[3];
                    if (storeCell && (!selectedCedis || (cedisCell && cedisCell.textContent.trim() === selectedCedis))) {
                        uniqueStores.add(storeCell.textContent.trim());
                    }
                });
            });
            const storeSelect = document.getElementById('store-select');
            storeSelect.innerHTML = '<option value="">Selecciona una tienda</option>';
            uniqueStores.forEach(store => {
                const option = document.createElement('option');
                option.value = store;
                option.textContent = store;
                storeSelect.appendChild(option);
            });
            storeSelect.style.display = 'block';
            document.getElementById('clear-store-filter').style.display = 'block';
        }

        function filterByStore() {
            const selectedStore = document.getElementById('store-select').value;
            const selectedCedis = document.getElementById('cedis-select').value;
            const tables = document.querySelectorAll('#data-table-container .group-container');
            tables.forEach(group => {
                const table = group.querySelector('table');
                let hasVisibleRows = false;
                const rows = table.querySelectorAll('tbody tr');
                rows.forEach(row => {
                    const storeCell = row.children[3];
                    const cedisCell = row.children[2];
                    let isVisible = true;
                    if (selectedCedis) {
                        isVisible = cedisCell && cedisCell.textContent.trim() === selectedCedis;
                    }
                    if (selectedStore) {
                        isVisible = isVisible && storeCell && storeCell.textContent.trim() === selectedStore;
                    }
                    row.style.display = isVisible ? '' : 'none';
                    if (isVisible) hasVisibleRows = true;
                });
                group.style.display = hasVisibleRows ? '' : 'none';
            });
        }

        function clearStoreFilter() {
            document.getElementById('store-select').value = '';
            filterByStore();
            document.getElementById('clear-store-filter').style.display = 'none';
        }

        function showUniqueCedis() {
            // Mostrar todos los cedis disponibles
            const tables = document.querySelectorAll('#data-table-container table');
            const uniqueCedis = new Set();
            tables.forEach(table => {
                const rows = table.querySelectorAll('tbody tr');
                rows.forEach(row => {
                    const cedisCell = row.children[2];
                    if (cedisCell) uniqueCedis.add(cedisCell.textContent.trim());
                });
            });
            const cedisSelect = document.getElementById('cedis-select');
            cedisSelect.innerHTML = '<option value="">Selecciona un cedis</option>';
            uniqueCedis.forEach(cedis => {
                const option = document.createElement('option');
                option.value = cedis;
                option.textContent = cedis;
                cedisSelect.appendChild(option);
            });
            cedisSelect.style.display = 'block';
            document.getElementById('clear-cedis-filter').style.display = 'block';
        }

        function filterByCedis() {
            const selectedCedis = document.getElementById('cedis-select').value;
            // Al cambiar cedis, actualizar tiendas disponibles
            showUniqueStores();
            // Si hay una tienda seleccionada, mantenerla
            const selectedStore = document.getElementById('store-select').value;
            const tables = document.querySelectorAll('#data-table-container .group-container');
            tables.forEach(group => {
                const table = group.querySelector('table');
                let hasVisibleRows = false;
                const rows = table.querySelectorAll('tbody tr');
                rows.forEach(row => {
                    const cedisCell = row.children[2];
                    const storeCell = row.children[3];
                    let isVisible = true;
                    if (selectedCedis) {
                        isVisible = cedisCell && cedisCell.textContent.trim() === selectedCedis;
                    }
                    if (selectedStore) {
                        isVisible = isVisible && storeCell && storeCell.textContent.trim() === selectedStore;
                    }
                    row.style.display = isVisible ? '' : 'none';
                    if (isVisible) hasVisibleRows = true;
                });
                group.style.display = hasVisibleRows ? '' : 'none';
            });
        }

        function clearCedisFilter() {
            document.getElementById('cedis-select').value = '';
            showUniqueStores();
            filterByCedis();
            document.getElementById('clear-cedis-filter').style.display = 'none';
        }

        function printContainerModa() {
            const groups = document.querySelectorAll('#data-table-container-moda .group-container');
            const modalLabelContainer = document.getElementById('modal-label-container');
            modalLabelContainer.innerHTML = '';
            const generalContainer = document.createElement('div');
            generalContainer.style.display = 'block';
            groups.forEach((group, idx) => {
                const titleElement = group.querySelector('div');
                const oc = titleElement.querySelector('div:nth-child(3)').textContent.split(': ')[1];
                const table = group.querySelector('table');
                const rows = table.querySelectorAll('tbody tr');


                // Extraer departamento 13 (índice 12) de la primera fila
                let departamento = '';
                if (rows.length > 0) {
                 const col13 = rows[0].children[12];
                if (col13) departamento = col13.textContent.trim();
                }

                 // Extraer modelo 3 (índice 2) de la primera fila
                 let modelo = '';
                if (rows.length > 0) {
                 const col13 = rows[0].children[2];
                if (col13) modelo = col13.textContent.trim();
                }

                // Extraer descripcion 12 (índice 11) de la primera fila
                let descripcion = '';
                if (rows.length > 0) {
                 const col13 = rows[0].children[11];
                if (col13) descripcion = col13.textContent.trim();
                }

                 // Extraer descripcion 4 (índice 3) de la primera fila
                 let color = '';
                if (rows.length > 0) {
                 const col13 = rows[0].children[3];
                if (col13) color = col13.textContent.trim();
                }

                // Extraer descripcion 9 (índice 8) de la primera fila
                let cedis2 = '';
                if (rows.length > 0) {
                 const col13 = rows[0].children[8];
                if (col13) cedis2 = col13.textContent.trim();
                }

                
                // Extraer tienda 2 (índice 1) de la primera fila
                let tienda2 = '';
                if (rows.length > 0) {
                 const col13 = rows[0].children[1];
                if (col13) tienda2 = col13.textContent.trim();
                }

                 // Extraer tallas 5 (índice 4) de la primera fila
                 let tallas = '';
                if (rows.length > 0) {
                 const col13 = rows[0].children[4];
                if (col13) tallas = col13.textContent.trim();
                }

                 // Extraer distribucion 7 (índice 6) de la primera fila
                 let pzas = '';
                if (rows.length > 0) {
                 const col13 = rows[0].children[6];
                if (col13) pzas = col13.textContent.trim();
                }


                 // Extraer razon social 14 (índice 13) de la primera fila
                 let razon = '';
                if (rows.length > 0) {
                 const col13 = rows[0].children[13];
                if (col13) razon = col13.textContent.trim();
                }

                  // Extraer total de pzas 8 (índice 7) de la primera fila
                  let totalpiezas = '';
                if (rows.length > 0) {
                 const col13 = rows[0].children[7];
                if (col13) totalpiezas = col13.textContent.trim();
                }



                let codigosYcantidades = [];
                let totalPiezas = 0;
                rows.forEach(row => {
                    const codigo = row.children[4]?.textContent.trim();
                    const cantidad = row.children[9]?.textContent.trim();
                    if (codigo && cantidad) {
                        codigosYcantidades.push(codigo + '\n' + cantidad);
                        totalPiezas += parseInt(cantidad) || 0;
                    }
                });
                const qrText = codigosYcantidades.join('\n');
                const totalCodigos = codigosYcantidades.length;
                const card = document.createElement('div');
                card.classList.add('card', 'p-3', 'shadow-sm');
                card.style.width = '152mm';
                card.style.height = '102mm';
                card.style.display = 'flex';
                card.style.flexDirection = 'row';
                card.style.justifyContent = 'space-between';
                card.style.alignItems = 'flex-start';
                card.style.textAlign = 'left';
                card.style.position = 'relative';
                let cedisNombre = cedis2;
                if (cedis2 === '4188') {
                    cedisNombre = 'MÉRIDA 4188';
                } else if (cedis2 === '4924') {
                    cedisNombre = 'MEXICALI 4924';
                } else if (cedis2 === '7490') {
                    cedisNombre = 'MONTERREY 7490';
                } else if (cedis2 === '4640') {
                    cedisNombre = 'CHIHUAHUA 4640';
                } else if (cedis2 === '7468') {
                    cedisNombre = 'VILLAHERMOSA 7468';
                } else if (cedis2 === '7493') {
                    cedisNombre = 'GUADALAJARA 7493';
                } else if (cedis2=== '7487') {
                    cedisNombre = 'CULIACAN 7487';
                } else if (cedis2 === '7471') {
                    cedisNombre = 'CHALCO 7471';
                } else if (cedis2 === '7464') {
                    cedisNombre = 'CUAUTITLAN 7464';
                }
                card.innerHTML = `
                    <div style="flex: 1; display: flex; flex-direction: column; align-items: flex-start; justify-content: flex-start;">
                       
                        <div style="font-size: 14px; font-weight: bold;"><strong>${razon}</strong></div>
                     
                        <div style="margin-top: 5px; font-size: 14px;">OC: <strong>${oc}</strong></div>
                        <div style="margin-top: 5px; font-size: 14px;">Departamento: <strong>${departamento}</strong></div>
                        <div style="margin-top: 5px; font-size: 14px;">Modelo: <strong>${modelo}</strong></div>
                        <div style="margin-top: 5px; font-size: 14px;">Descripción: <strong>${descripcion}</strong></div>
                        <div style="margin-top: 5px; font-size: 14px;">Color: <strong>${color}</strong></div>

                        
                        <div style="margin-top: 5px; font-size: 14px;">Cedis: <strong>${cedisNombre}</strong></div>
                         <div style="font-size: 14px; font-weight: bold;">UPC Código Padre</div>

                        <div style="margin-top: 5px; font-size: 14px; text-align: center;">
                        <svg id="modal-barcode-moda-${idx}" style="margin-top:1px;"></svg>
                        <br>
                       
                        <strong>${tienda2}</strong>
                       
                        <div style="margin-top: 5px; font-size: 14px;text-align: left;">Tallas: <strong>${tallas}</strong></div> 
                         <div style="margin-top: 5px; font-size: 14px;text-align: left;">Piezas: <strong>${pzas}</strong></div>

                        <div style="margin-top: 5px; font-size: 14px;text-align: left;">Total de piezas: <strong>${totalpiezas}</strong></div>


                        </div>
                    </div>
                    <div style="display: flex; flex-direction: column; align-items: center; justify-content: flex-start; min-width: 50px;">

                       
                        




                        
                      
                           
                        </div>
                    </div>
                `;
                generalContainer.appendChild(card);
                setTimeout(() => {
                    try {
                        JsBarcode(`#modal-barcode-moda-${idx}`, tienda2, {
                            format: "CODE128",
                            width: 1.5,
                            height: 30,
                            displayValue: false,
                            margin: 0
                        });
                    } catch (e) {}
                }, 0);
                setTimeout(() => {
                    
                }, 0);
            });
            modalLabelContainer.appendChild(generalContainer);
            const printModal = new bootstrap.Modal(document.getElementById('printModal'));
            printModal.show();
        }

        // Funciones de filtros e impresión para Etiquetas "Resurtidos"
        function showUniqueModels() {
            const tables = document.querySelectorAll('#data-table-container table');
            const uniqueModels = new Set();
            tables.forEach(table => {
                const rows = table.querySelectorAll('tbody tr');
                rows.forEach(row => {
                    const modelCell = row.children[5];
                    if (modelCell) uniqueModels.add(modelCell.textContent.trim());
                });
            });
            const modelSelect = document.getElementById('model-select');
            modelSelect.innerHTML = '<option value="">Selecciona un modelo</option>';
            uniqueModels.forEach(model => {
                const option = document.createElement('option');
                option.value = model;
                option.textContent = model;
                modelSelect.appendChild(option);
            });
            modelSelect.style.display = 'block';
            document.getElementById('clear-model-filter').style.display = 'block';
        }

        function filterByModel() {
            const selectedModel = document.getElementById('model-select').value;
            const tables = document.querySelectorAll('#data-table-container .group-container');
            tables.forEach(group => {
                const table = group.querySelector('table');
                let hasVisibleRows = false;
                const rows = table.querySelectorAll('tbody tr');
                rows.forEach(row => {
                    const modelCell = row.children[5];
                    if (modelCell) {
                        const isVisible = selectedModel ? modelCell.textContent.trim() === selectedModel : true;
                        row.style.display = isVisible ? '' : 'none';
                        if (isVisible) hasVisibleRows = true;
                    }
                });
                group.style.display = hasVisibleRows ? '' : 'none';
            });
        }

        function clearModelFilter() {
            document.getElementById('model-select').value = '';
            filterByModel();
            document.getElementById('clear-model-filter').style.display = 'none';
        }

        function printContainer() {
            const groups = document.querySelectorAll('#data-table-container .group-container');
            const modalLabelContainer = document.getElementById('modal-label-container');
            modalLabelContainer.innerHTML = '';
            const generalContainer = document.createElement('div');
            generalContainer.style.display = 'block';
            groups.forEach((group, idx) => {
                if (group.style.display === 'none') return;
                const titleElement = group.querySelector('div');
                const cedis = titleElement.querySelector('div:nth-child(1)').textContent.split(': ')[1];
                // Obtener el valor de la columna 4 (índice 3) de la primera fila visible
                const table = group.querySelector('table');
                const rows = table.querySelectorAll('tbody tr');
                let codigoCol4 = '';
                let oc = '';
                for (let i = 0; i < rows.length; i++) {
                    if (rows[i].style.display === 'none') continue;
                    codigoCol4 = rows[i].children[3]?.textContent.trim() || '';
                    oc = rows[i].children[1]?.textContent.trim() || '';
                    break;
                }
                const tienda = titleElement.querySelector('div:nth-child(2)').textContent.split(': ')[1];
                const cajaDiv = titleElement.querySelector('.caja-info');
                let cajaTexto = cajaDiv ? cajaDiv.textContent : '';
                let codigosYcantidades = [];
                let totalPiezas = 0;
                rows.forEach(row => {
                    if (row.style.display === 'none') return;
                    const codigo = row.children[4]?.textContent.trim();
                    const cantidad = row.children[9]?.textContent.trim();
                    if (codigo && cantidad) {
                        codigosYcantidades.push(codigo + '\n' + cantidad);
                        totalPiezas += parseInt(cantidad) || 0;
                    }
                });
                if (codigosYcantidades.length === 0) return;
                const qrText = codigosYcantidades.join('\n');
                const totalCodigos = codigosYcantidades.length;
                let cedisNombre = cedis;
                if (cedis === '4188') {
                    cedisNombre = 'MÉRIDA 4188';
                } else if (cedis === '4924') {
                    cedisNombre = 'MEXICALI 4924';
                } else if (cedis === '7490') {
                    cedisNombre = 'MONTERREY 7490';
                } else if (cedis === '4640') {
                    cedisNombre = 'CHIHUAHUA 4640';
                } else if (cedis === '7468') {
                    cedisNombre = 'VILLAHERMOSA 7468';
                } else if (cedis === '7493') {
                    cedisNombre = 'GUADALAJARA 7493';
                } else if (cedis === '7487') {
                    cedisNombre = 'CULIACAN 7487';
                } else if (cedis === '7471') {
                    cedisNombre = 'CHALCO 7471';
                } else if (cedis === '7464') {
                    cedisNombre = 'CUAUTITLAN 7464';
                }
                const card = document.createElement('div');
                card.classList.add('p-3');
                card.style.display = 'flex';
                card.style.justifyContent = 'space-between';
                card.style.alignItems = 'flex-start';
                card.style.textAlign = 'left';
                card.style.position = 'relative';
                card.innerHTML = `
                    <div style="flex: 1; display: flex; flex-direction: column; align-items: flex-start; justify-content: flex-start;">
                        <div style="font-size: 12px; font-weight: bold;">LA NUIT SA DE CV</div>
                        <div style="margin-top: 6px; font-size: 12px;">Proveedor: 627375</div>
                        <div style="margin-top: 5px; font-size: 12px;">OC: <strong>${oc}</strong></div>
                        <div style="margin-top: 5px; font-size: 12px;">Cedis: <strong>${cedisNombre}</strong></div>
                        <div style="margin-top: 5px; font-size: 12px; color: #333;"><strong>${cajaTexto}</strong></div>
                        <div style="margin-top: 5px; font-size: 12px; text-align: center;">
                            <svg id="modal-barcode-${idx}" style="margin-top:1px;"></svg>
                            <div style="font-size: 14px; font-weight: bold; margin-top:2px; text-align:center;">${codigoCol4}</div>
                        </div>
                    </div>
                    <div style="width: 151px; display: flex; flex-direction: column; align-items: flex-end; justify-content: flex-start;">
                        <div class="qr-wrapper" style="
                            display: flex;
                            flex-direction: column;
                            align-items: center;
                            margin-bottom: 8px;
                        ">
                            <div id="modal-qr-${idx}"></div>
                            <div style="
                                margin-top: 4px;
                                font-size: 0.6rem;
                                font-weight: bold;
                                letter-spacing: 2px;
                                padding: 2px 5px;
                            ">
                                Códigos:${totalCodigos}/Piezas:${totalPiezas}
                            </div>
                        </div>
                    </div>
                `;
                generalContainer.appendChild(card);
                setTimeout(() => {
                    try {
                        JsBarcode(`#modal-barcode-${idx}`, codigoCol4, {
                            format: "CODE128",
                            width: 1.5,
                            height: 42,
                            displayValue: false,
                            margin: 0
                        });
                    } catch (e) {}
                }, 0);
                setTimeout(() => {
                    const qrDiv = document.getElementById(`modal-qr-${idx}`);
                    if (qrDiv) {
                        qrDiv.innerHTML = "";
                        new QRCode(qrDiv, {
                            text: qrText,
                            width: 110,
                            height: 110,
                            correctLevel: QRCode.CorrectLevel.H
                        });
                    }
                }, 0);
            });
            modalLabelContainer.appendChild(generalContainer);
            const printModal = new bootstrap.Modal(document.getElementById('printModal'));
            printModal.show();
        }

        function printModalLabels() {
            const printContents = document.getElementById('modal-label-container').innerHTML;
            const originalContents = document.body.innerHTML;
            const printStyle = `
                <style>
                    @media print {
                        html, body {
                            width: auto !important;
                            height: auto !important;
                            margin: 0 !important;
                            padding: 0 !important;
                            background: #fff !important;
                        }
                        #modal-label-container {
                            display: block !important;
                            width: 100% !important;
                            min-width: 0 !important;
                            max-width: none !important;
                            margin: 0 !important;
                            padding: 0 !important;
                        }
                        #modal-label-container .card {
                            page-break-before: auto;
                            page-break-after: always;
                            break-before: auto;
                            break-after: page;
                            display: block !important;
                            width: 100mm !important;
                            height: 60mm !important;
                            max-width: none !important;
                            margin: 0 auto 0 auto !important;
                            box-shadow: none !important;
                            background: #fff !important;
                        }
                    }
                </style>
            `;
            document.body.innerHTML = printStyle + printContents;
            window.print();
            document.body.innerHTML = originalContents;
            window.location.reload();
        }

        function duplicateRow(button) {
            const row = button.closest('tr');
            const clone = row.cloneNode(true);
            const btns = clone.querySelectorAll('button');
            if (btns.length === 3) {
                btns[0].setAttribute('onclick', 'enableEdit(this)');
                btns[1].setAttribute('onclick', 'deleteRow(this)');
                btns[2].setAttribute('onclick', 'duplicateRow(this)');
            }
            row.parentNode.insertBefore(clone, row.nextSibling);
            const table = row.closest('table');
            const titleElement = table.previousElementSibling;
            const piezas = parseInt(row.children[9]?.textContent || 0);
            const totalMatch = titleElement.innerHTML.match(/<strong>Total de piezas:<\/strong> (\d+)/);
            if (totalMatch) {
                const totalActual = parseInt(totalMatch[1]);
                const nuevoTotal = totalActual + piezas;
                titleElement.innerHTML = titleElement.innerHTML.replace(
                    /<strong>Total de piezas:<\/strong> \d+/,
                    `<strong>Total de piezas:</strong> ${nuevoTotal}`
                );
            }
            showNotification('Fila duplicada correctamente.', 'success');
        }
        function duplicateRowModa(button) {
            const row = button.closest('tr');
            const clone = row.cloneNode(true);
            const btns = clone.querySelectorAll('button');
            if (btns.length === 3) {
                btns[0].setAttribute('onclick', 'enableEditModa(this)');
                btns[1].setAttribute('onclick', 'deleteRowModa(this)');
                btns[2].setAttribute('onclick', 'duplicateRowModa(this)');
            }
            row.parentNode.insertBefore(clone, row.nextSibling);
            const table = row.closest('table');
            const titleElement = table.previousElementSibling;
            const piezas = parseInt(row.children[9]?.textContent || 0);
            const totalMatch = titleElement.innerHTML.match(/<strong>Total de piezas:<\/strong> (\d+)/);
            if (totalMatch) {
                const totalActual = parseInt(totalMatch[1]);
                const nuevoTotal = totalActual + piezas;
                titleElement.innerHTML = titleElement.innerHTML.replace(
                    /<strong>Total de piezas:<\/strong> \d+/,
                    `<strong>Total de piezas:</strong> ${nuevoTotal}`
                );
            }
            showNotification('Fila duplicada correctamente.', 'success');
        }

        function duplicateGroup(btn) {
            const titleDiv = btn.closest('.d-flex');
            const groupContainer = titleDiv.parentNode;
            const container = groupContainer.parentNode;
            const clone = groupContainer.cloneNode(true);
            const key = groupContainer.getAttribute('data-group-key');
            const allGroups = Array.from(container.querySelectorAll(`[data-group-key="${key}"]`));
            const totalCajas = allGroups.length + 1;
            allGroups.forEach((g, idx) => {
                g.setAttribute('data-caja', idx + 1);
                g.setAttribute('data-total-cajas', totalCajas);
                const cajaDiv = g.querySelector('.caja-info');
                if (cajaDiv) cajaDiv.innerHTML = `Caja: ${idx + 1} de ${totalCajas}`;
                const btns = g.querySelectorAll('button');
                if (btns.length >= 2) {
                    btns[1].style.display = (idx > 0) ? 'inline-block' : 'none';
                }
            });
            clone.setAttribute('data-caja', totalCajas);
            clone.setAttribute('data-total-cajas', totalCajas);
            const cajaDivClone = clone.querySelector('.caja-info');
            if (cajaDivClone) cajaDivClone.innerHTML = `Caja: ${totalCajas} de ${totalCajas}`;
            const btnsClone = clone.querySelectorAll('button');
            if (btnsClone.length >= 2) {
                btnsClone[1].style.display = 'inline-block';
            }
            if (allGroups.length > 0) {
                allGroups[allGroups.length - 1].after(clone);
            } else {
                container.appendChild(clone);
            }
            updateAllGroupTotals(container, key);
        }

        function removeGroupDuplicate(btn) {
            const titleDiv = btn.closest('.d-flex');
            const groupContainer = titleDiv.parentNode;
            const container = groupContainer.parentNode;
            const key = groupContainer.getAttribute('data-group-key');
            groupContainer.remove();
            const allGroups = Array.from(container.querySelectorAll(`[data-group-key="${key}"]`));
            const totalCajas = allGroups.length;
            allGroups.forEach((g, idx) => {
                g.setAttribute('data-caja', idx + 1);
                g.setAttribute('data-total-cajas', totalCajas);
                const cajaDiv = g.querySelector('.caja-info');
                if (cajaDiv) cajaDiv.innerHTML = `Caja: ${idx + 1} de ${totalCajas}`;
                const btns = g.querySelectorAll('button');
                if (btns.length >= 2) {
                    btns[1].style.display = (idx > 0) ? 'inline-block' : 'none';
                }
            });
            updateAllGroupTotals(container, key);
        }

        function updateAllGroupTotals(container, key) {
            const allGroups = Array.from(container.querySelectorAll(`[data-group-key="${key}"]`));
            allGroups.forEach(g => {
                const table = g.querySelector('table');
                const titleElement = g.querySelector('.d-flex');
                updateTotalPiezas(table, titleElement);
            });
        }
    </script>
</body>
</html>

